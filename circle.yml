machine:
  timezone: Asia/Tokyo
  ruby:
    version:
      2.1.2
  environment:
    AWS_AMI_ID: ami-29160d47
    AWS_INSTANCE_TYPE: t2.micro
    SSH_USER: ec2-user

dependencies:
  pre:
    - sudo pip install ansible

test:
  pre:
    - aws cloudformation create-stack --stack-name ci-test --template-body file://cloudformation.json --parameters ParameterKey=KeyName,ParameterValue=$AWS_KEY_NAME ParameterKey=AmiId,ParameterValue=$AWS_AMI_ID ParameterKey=InstanceType,ParameterValue=$AWS_INSTANCE_TYPE
    - sleep 90
    - aws cloudformation describe-stacks --stack-name ci-test | jq -r '.Stacks[].Outputs[].OutputValue' > /tmp/publicip.txt
    - echo "`cat /tmp/publicip.txt` testserver" >> /tmp/hosts.txt
    - cp /etc/hosts .
    - sudo bash -c "cat hosts /tmp/hosts.txt | tee /etc/hosts"
    - echo "Host testserver" >> ~/.ssh/config
    - echo "User ec2-user" >> ~/.ssh/config
    - ssh $SSH_USER@testserver sudo yum update -y
  override:
    